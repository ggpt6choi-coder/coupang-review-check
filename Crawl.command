#!/bin/bash

# 현재 스크립트가 있는 디렉토리로 이동
cd "$(dirname "$0")"

echo "======================================================"
echo "🚀 쿠팡 리뷰 크롤러 원클릭 실행기 시작"
echo "======================================================"

# 1. 브라우저 실행 (이미 실행 중이면 건너뜀)
if lsof -Pi :9222 -sTCP:LISTEN -t >/dev/null ; then
    echo "[1/3] ✅ 브라우저가 이미 실행 중입니다."
else
    echo "[1/3] 🌐 디버그 브라우저를 시작합니다..."
    # 같은 디렉토리에 있는 run_browser.sh 실행
    nohup sh ./run_browser.sh > /dev/null 2>&1 &
    sleep 3
fi

# 2. 크롤러 서버 실행
echo "[2/3] ⚙️ 서버를 구동합니다..."
# 기존에 실행 중인 서버가 있다면 종료 (3000 포트)
lsof -ti :3000 | xargs kill -9 > /dev/null 2>&1
nohup node unified_crawler.js > /dev/null 2>&1 &
sleep 2

# 3. 대시보드 열기
echo "[3/3] 🎨 관리 화면을 엽니다..."
open http://localhost:3000

echo "======================================================"
echo "✅ 실행 완료! 브라우저의 대시보드 화면을 확인하세요."
echo "터미널 창을 닫아도 서버는 백그라운드에서 계속 실행됩니다."
echo "======================================================"
